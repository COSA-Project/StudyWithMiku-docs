"use strict";(self.webpackChunkTopWritePlugins_weaccount=self.webpackChunkTopWritePlugins_weaccount||[]).push([[826],{826:(e,t,r)=>{r.r(t),r.d(t,{default:()=>_});var o,a=r(99),n=r(196),i=r(483);function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},s.apply(this,arguments)}var l=function(e){return n.createElement("svg",s({className:"icon_svg__icon",viewBox:"0 0 1024 1024",xmlns:"http://www.w3.org/2000/svg",width:18,height:18},e),o||(o=n.createElement("path",{d:"M118.438 395.821c2.369-6.149 33.678 183.946 178.428 278.972l-15.978 88.06c40.236 1.303 78.704-16.536 103.663-48.072l-.086-.086c84.842 23.606 196.817 17.2 343.246-47.298 0 0-43.24 143.184-125.283 194.781-152.07 95.37-391.61 50.738-483.258-107.495-26.056-44.976-68.305-170.702-.732-358.862zm624.476-100.788c148.088 53.771 229.99 212.072 188.204 363.764-14.73 49.792-44.489 149.376-227.525 229.61-9.82 4.386 293.331-368.45-161.674-588.472a367.37 367.37 0 0 1 200.995-4.902zm49.484-62.69c6.89 8.34-416.676-105.991-518.918 322.485v-.215l-.1-.113c-3.226-3.672-83.855-96.422-80.479-191.444C211.493 203.351 345.881 82.208 506.905 80c52.068 0 156.248 0 285.493 152.342z",fill:"#1FC372"})))};var c=r(511),d=r.n(c);const u=e=>(t,r)=>{if("0px"===r.getPropertyValue(`border-${e}-width`))return t},p={background:void 0,"background-color":"rgba(0, 0, 0, 0)","background-image":"none",color:(e,t,r)=>{if("CODE"!==r.tagName)return"rgb(51, 51, 51)"},"font-family":(e,t,r)=>["div","article","section","blockquote","table","thead","tbody","tr"].includes(r.tagName.toLowerCase())?e:'mp-quote, -apple-system-font, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei UI", "Microsoft YaHei", Arial, sans-serif',"font-size":"17px","font-style":"normal","font-weight":(e,t,r)=>"B"===r.tagName||"STRONG"===r.tagName||"TH"===r.tagName?"700":"400","text-decoration":(e,t,r)=>{if("none"===t.getPropertyValue("text-decoration-line")||"A"===r.tagName)return e},"line-height":void 0,"text-align":"start","padding-top":"0px","padding-left":"0px","padding-right":"0px","padding-bottom":"0px","margin-top":"0px","margin-left":"0px","margin-right":"0px","margin-bottom":"0px","border-top-width":"0px","border-top-color":u("top"),"border-top-style":u("top"),"border-left-width":"0px","border-left-color":u("left"),"border-left-style":u("left"),"border-right-width":"0px","border-right-color":u("right"),"border-right-style":u("right"),"border-bottom-width":"0px","border-bottom-color":u("bottom"),"border-bottom-style":u("bottom"),"border-top-left-radius":"0px","border-top-right-radius":"0px","border-bottom-left-radius":"0px","border-bottom-right-radius":"0px","max-width":"none",width:(e,t,r)=>["table"].includes(r.tagName.toLowerCase())?()=>"100%":e,height:(e,t,r)=>{if(!["th","td"].includes(r.tagName.toLowerCase()))return e},"overflow-x":"visible","overflow-y":"visible",display:(e,t,r)=>["div","article","section","blockquote","pre","table","ol","li","ul","h1","h2","h3","h4","h5","h6","hr","p"].includes(r.tagName.toLowerCase())?"block":["a","br","code","em","span","strong"].includes(r.tagName.toLowerCase())?"inline":["img"].includes(r.tagName.toLowerCase())?"inline-block":["tr"].includes(r.tagName.toLowerCase())?"table-row":["td","th"].includes(r.tagName.toLowerCase())?"table-cell":["thead"].includes(r.tagName.toLowerCase())?"table-header-group":["tbody"].includes(r.tagName.toLowerCase())?"table-row-group":void 0,"tab-size":"8","white-space":"normal","word-break":"normal","border-collapse":()=>"separate","table-layout":"auto",fill:"rgb(0, 0, 0)",stroke:"none","fill-rule":"nonzero","fill-opacity":"1","stroke-width":"1px","stroke-linecap":"butt","stroke-linejoin":"miter","stroke-miterlimit":"4","stroke-dasharray":"none","stroke-dashoffset":"0px"};function g(e){const t=getComputedStyle(e);Array.from(t).forEach((r=>{if(Object.keys(p).includes(r)){const o=t.getPropertyValue(r),a=p[r];if(void 0===a)e.style[r]=o;else if("function"==typeof a){const n=a(o,t,e);n!==o&&(e.style[r]="function"==typeof n?n():o)}else a!==o&&(e.style[r]=o)}})),Array.from(e.children).forEach((e=>{g(e)}))}function m(e){e.removeAttribute("class"),Array.from(e.children).forEach((e=>{m(e)}))}const h=a.request.create({baseURL:"https://www.topthink.com"});var f=r(444),b=r.n(f);const w=r.p+"media/img.f44ba2c8.png";var y;function x(){return x=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},x.apply(this,arguments)}var v=function(e){return n.createElement("svg",x({className:"check_svg__icon",viewBox:"0 0 1024 1024",xmlns:"http://www.w3.org/2000/svg",width:20,height:20},e),y||(y=n.createElement("path",{fill:"currentColor",d:"M328 800q-3.008 0-4.992-.992-20-2.016-30.016-20L133.984 500.992q-8-15.008-4-31.008t18.496-24 30.496-3.488 24.992 18.496L336.96 693.984l491.008-492q11.008-12 28-12t28.512 11.488 11.488 28.512-12 28L355.968 788q-11.008 12-28 12z"})))};function k(){const{config:e}=(0,a.useBook)();return function(e){const t=r(181);return e.getPluginConfig("weaccount",t)}(e)}function C(e){let{state:t}=e;const r=(0,a.useFile)(),o=(0,n.useRef)(null),s=(0,n.useRef)(null),[l,c]=(0,n.useState)(!1),[u,p]=(0,n.useState)(!1),[f,y]=(0,n.useState)(),x=k(),{state:C,show:N}=(0,a.useOverlayState)({onHide:()=>{p(!1),y(void 0)}}),_=(0,n.useCallback)((async e=>{let{formData:t}=e;try{if(f){c(!0);const e=await d()().use((e=>{const t=[];return e.match({tag:"img"},(e=>(t.push(new Promise((async(t,r)=>{try{const r=b()(e.attrs);if(r.src){let t;try{t=(await a.request.get(r.src,{responseType:"blob"})).data}catch(e){if(!e.isAxiosError||void 0!==e.response)throw e;t=r.src}r.src=await async function(e,t){const r=new FormData;return"string"==typeof e?r.append("url",e):r.append("media",new File([e],"image.png")),(await h.post("/api/weaccount/media/image",r,{headers:{Authorization:`Bearer ${t}`}})).data.url}(t,x.getValue("api_token")),e.attrs=r.compose()}t()}catch(e){r(e)}}))),e))),Promise.all(t).then((()=>e))})).process(f),n=await async function(e,t){const r=new FormData;return r.append("type","image"),r.append("media",new File([e],"image.png")),(await h.post("/api/weaccount/material",r,{headers:{Authorization:`Bearer ${t}`}})).data.media_id}(function(e){const t=e.split(","),r=t[0].match(/:(.*?);/)[1],o=atob(t[1]);let a=o.length;const n=new Uint8Array(a);for(;a--;)n[a]=o.charCodeAt(a);return new Blob([n],{type:r})}(t.cover),x.getValue("api_token"));await(r={title:t.title,author:t.author,digest:t.digest,content:e.html,content_source_url:t.content_source_url,thumb_media_id:n},o=x.getValue("api_token"),h.post("/api/weaccount/draft",{articles:[r]},{headers:{Authorization:`Bearer ${o}`}})),p(!0)}}catch(e){e.isAxiosError?a.Toast.error(e.response.data):a.Toast.error(e.message)}finally{c(!1)}var r,o}),[f,c,t.onHide,p]),P=(0,n.useMemo)((()=>({cover:{"ui:widget":"upload","ui:options":{onUpload:async e=>new Promise((t=>{const r=new FileReader;r.onloadend=function(){t(r.result)},r.readAsDataURL(e)}))}},title:{"ui:placeholder":"请输入文章标题"},author:{"ui:placeholder":"请输入文章作者"},digest:{"ui:placeholder":"选填","ui:widget":"textarea"},content_source_url:{"ui:placeholder":"选填，请输入原文链接"}})),[]);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(a.Modal,{...t,scrollable:!0,title:"内容预览",okText:"同步",onEntered:()=>{if(s.current){const e=s.current.querySelector("article");e&&(g(e),m(e)),y(s.current.innerHTML)}},onOk:e=>{x.getValue("api_token")?N():(e.preventDefault(),a.Toast.error("插件所需的API令牌尚未配置"))},children:(0,i.jsx)(j,{ref:s,children:(0,i.jsx)(a.Markdown,{children:r.content.toString()})})}),(0,i.jsx)(a.Modal,{...C,title:"同步到微信公众号",size:"lg",onOk:e=>{var t;(e.preventDefault(),u)?window.open("https://mp.weixin.qq.com"):null===(t=o.current)||void 0===t||t.submit()},okText:u?"去微信公众号":void 0,cancelText:u?"知道了":void 0,confirmLoading:l,children:u?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("img",{className:"w-100",src:w}),(0,i.jsxs)("p",{className:"mt-3 mb-0 d-flex align-items-center fs-5 text-muted",children:[(0,i.jsx)(v,{className:"text-success me-2"}),"图文已同步至微信公众号平台「 内容与互动 」- 「 草稿箱 」"]})]}):(0,i.jsx)(a.Form,{onSubmit:_,ref:o,formContext:{layout:"horizontal"},schema:{type:"object",properties:{cover:{type:"string",title:"封面"},title:{type:"string",title:"标题"},author:{type:"string",title:"作者"},digest:{type:"string",title:"摘要"},content_source_url:{type:"string",title:"原文链接"}},required:["cover","title"]},uiSchema:P})})]})}const j=a.styled.div`
  color: rgb(51, 51, 51);
  border-color: transparent;
  font-size: 17px;
  min-height: 150px;
  font-family: "mp-quote", -apple-system-font, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei UI", "Microsoft YaHei", Arial, sans-serif;

  * {
    margin: 0;
    padding: 0
  }
`,N=(0,a.createMarkdownPlatePlugin)({tools:()=>({"-10:3":e=>{let{Component:t}=e;const{state:r,show:o}=(0,a.useOverlayState)();return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t,{title:"同步到微信公众号",handler:o,children:(0,i.jsx)(l,{})}),(0,i.jsx)(C,{state:r})]})}})});function _(e){let{children:t}=e;const{addPlugin:r,removePlugin:o}=(0,a.useActions)("editor");return(0,n.useEffect)((()=>(r(N),()=>{o(N)})),[]),t}}}]);
//# sourceMappingURL=826-d5b098.js.map